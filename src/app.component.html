<div class="h-[100dvh] w-full relative overflow-hidden font-sans selection:bg-white/20 selection:text-white"
  [style.background-color]="geminiService.activeTheme().visualStyle.backgroundColor === '#f4f1ea' ? '#050505' : geminiService.activeTheme().visualStyle.backgroundColor"
  [style.--theme-bg]="geminiService.activeTheme().visualStyle.backgroundColor === '#f4f1ea' ? '#050505' : geminiService.activeTheme().visualStyle.backgroundColor"
  [style.--theme-primary]="geminiService.activeTheme().visualStyle.primaryColor"
  [style.--theme-text]="geminiService.activeTheme().visualStyle.textColor"
  [style.--font-header]="geminiService.activeTheme().visualStyle.fontFamilyHeader"
  [style.color]="geminiService.activeTheme().id === 'mars' ? '#d1d5db' : geminiService.activeTheme().visualStyle.textColor">

  <!-- Global Scanline Overlay -->
  <div class="fixed inset-0 pointer-events-none z-0 opacity-10"
    style="background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%;">
  </div>

  <!-- Vignette -->
  <div
    class="fixed inset-0 pointer-events-none z-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.8)_100%)]">
  </div>

  <!-- Header -->
  <header
    class="absolute top-0 left-0 w-full p-4 pt-6 md:p-6 z-30 flex justify-between items-start backdrop-blur-[2px]">
    <div class="flex flex-col">
      <span class="text-[10px] font-bold tracking-[0.2em] uppercase leading-none transition-colors"
        [style.color]="'var(--theme-primary)'" [style.font-family]="'var(--font-header)'">
        {{ geminiService.activeTheme().name }}
      </span>
      <span class="text-[8px] font-mono opacity-60 leading-none mt-1 tracking-wider transition-colors"
        [style.color]="'var(--theme-primary)'">
        {{ geminiService.activeTheme().headerStatus }}
      </span>
    </div>

    <div class="flex items-center gap-3 shrink-0">
      <button (click)="toggleAbout()"
        class="px-3 py-1.5 rounded border border-white/10 bg-black/40 backdrop-blur-sm text-[10px] font-mono text-white/60 hover:text-white hover:border-white/30 uppercase tracking-widest transition-all">
        INFO
      </button>
      <button (click)="reset()"
        class="px-3 py-1.5 rounded border border-white/10 bg-black/40 backdrop-blur-sm text-[10px] font-mono text-white/60 hover:text-[var(--theme-primary)] hover:border-[var(--theme-primary)] uppercase tracking-widest transition-all">
        RESET
      </button>
    </div>
  </header>

  <!-- Info Modal (Unified Terminal Style - Zinc Variant) -->
  @if (showAbout()) {
  <div
    class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in font-mono text-zinc-300"
    (click)="toggleAbout()">
    <div
      class="max-w-md w-full border-2 border-zinc-800 bg-[#050505] p-1 relative shadow-[0_0_40px_rgba(255,255,255,0.05)]"
      (click)="$event.stopPropagation()">

      <!-- Inner CRT Frame -->
      <div class="border border-zinc-800/50 bg-zinc-900/5 p-8 relative overflow-hidden">

        <!-- Scanlines -->
        <div class="absolute inset-0 pointer-events-none opacity-10"
          style="background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%;">
        </div>

        <!-- Header -->
        <div class="flex justify-between items-start mb-8 border-b border-zinc-800/50 pb-2">
          <h2 class="text-zinc-500 text-[10px] tracking-[0.25em] uppercase flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-pulse"></span>
            >>> SYSTEM_INFO.LOG
          </h2>
          <button (click)="toggleAbout()"
            class="text-zinc-600 hover:text-white text-[10px] uppercase tracking-widest transition-colors">[X]</button>
        </div>

        <!-- Content -->
        <div class="space-y-6 text-zinc-400 text-[11px] leading-relaxed relative z-10">
          <p class="font-serif italic text-lg text-zinc-200 border-l-2 border-zinc-700/50 pl-4">
            A postcard is a bridge between worlds.
          </p>

          <div class="space-y-4 pt-2">
            <p>
              > This system is a quiet attempt to bridge the distance between alternative realities.
            </p>
            <p>
              > It uses Multimodal AI to extract the emotional resonance of your memories, translating them into
              artifacts from other timelines.
            </p>
            <p>
              > Choose a destination frequency, provide a visual anchor, and find the words to send back.
            </p>
          </div>
        </div>

        <div
          class="mt-8 w-full border border-zinc-800/30 hover:bg-zinc-900/20 py-3 text-center transition-colors cursor-pointer"
          (click)="toggleAbout()">
          <span class="text-[9px] text-zinc-500 uppercase tracking-[0.2em]">
            [ CLOSE_TERMINAL ]
          </span>
        </div>
      </div>
    </div>
  </div>
  }

  <main class="relative z-10 w-full h-full overflow-y-auto overflow-x-hidden">

    @switch (state()) {

    @case ('landing') {
    <div class="w-full min-h-full flex flex-col justify-center py-20">
      <app-destination-gallery (imageSelected)="onImageSelected($event)"></app-destination-gallery>
    </div>
    }

    @case ('analyzing') {
    <div class="min-h-full w-full max-w-2xl mx-auto flex flex-col items-center justify-center px-4 pt-20 pb-8">
      <div class="flex flex-col items-center gap-6 text-center px-6 animate-fade-in">
        <!-- Linear Loader -->
        <div class="w-24 h-px relative overflow-hidden" [style.background-color]="'var(--theme-text)'"
          style="opacity: 0.2">
          <div class="absolute h-full animate-progress bg-[var(--theme-primary)]" style="opacity: 1 !important"></div>
        </div>

        <div class="font-mono space-y-2">
          <h3 class="text-xs tracking-widest uppercase text-[var(--theme-primary)]">{{
            geminiService.activeTheme().loadingText }}</h3>
          <p class="text-[10px] text-[var(--theme-text)] uppercase tracking-wider min-h-[1rem] opacity-90">{{
            loadingMessage() }}</p>
        </div>
      </div>
    </div>
    }

    @case ('dialogue') {
    <div class="min-h-full w-full max-w-2xl mx-auto flex flex-col items-center justify-center px-4 pt-20 pb-8">
      <app-dialogue [imageSrc]="originalImage()!" [starterText]="currentStarter()" [history]="poemHistory()"
        [suggestions]="currentSuggestions()" [loading]="loadingNextLine()" [isLastLine]="poemHistory().length === 2"
        [finalizeLabel]="geminiService.activeTheme().finalizeLabel" (lineCompleted)="onLineCompleted($event)"
        (finished)="finishCreation($event)"></app-dialogue>
    </div>
    }

    @case ('generating') {
    <div class="min-h-full w-full max-w-2xl mx-auto flex flex-col items-center justify-center px-4 pt-20 pb-8">
      <div class="flex flex-col items-center gap-6 text-center px-6 animate-fade-in">
        <!-- Linear Loader -->
        <div class="w-24 h-px relative overflow-hidden" [style.background-color]="'var(--theme-text)'"
          style="opacity: 0.2">
          <div class="absolute h-full animate-progress bg-[var(--theme-primary)]" style="opacity: 1 !important"></div>
        </div>

        <div class="font-mono space-y-2">
          <h3 class="text-xs tracking-widest uppercase text-[var(--theme-primary)]">{{
            geminiService.activeTheme().generatingText }}</h3>
          <p class="text-[10px] text-gray-400 uppercase tracking-wider min-h-[1rem]">{{ loadingMessage() }}</p>
        </div>
      </div>
    </div>
    }

    @case ('result') {
    <div class="min-h-full w-full max-w-2xl mx-auto flex flex-col items-center justify-center px-4 pt-20 pb-8">
      <app-postcard-result [poem]="finalPoem()" [stylizedImageSrc]="stylizedImage()" [imagePrompt]="generatedPrompt()"
        [isRegenerating]="isRegenerating()" [version]="promptVersion()" (regenerate)="onRegenerateImage($event)"
        (poemChange)="onPoemChanged($event)"></app-postcard-result>

      <app-film-strip (themeSwitch)="onThemeSwitched($event)"></app-film-strip>
    </div>
    }

    }
  </main>
</div>