<div class="h-[100dvh] w-full relative overflow-hidden font-sans selection:bg-white/20 selection:text-white"
  [style.background-color]="geminiService.getAppBackground(geminiService.activeTheme())"
  [style.--theme-bg]="geminiService.getAppBackground(geminiService.activeTheme())"
  [style.--theme-primary]="geminiService.activeTheme().visualStyle.primaryColor"
  [style.--theme-text]="geminiService.activeTheme().visualStyle.textColor"
  [style.--font-header]="geminiService.activeTheme().visualStyle.fontFamilyHeader"
  [style.color]="geminiService.activeTheme().id === 'mars' ? '#d1d5db' : geminiService.activeTheme().visualStyle.textColor">

  <!-- Global Scanline Overlay -->
  <div class="fixed inset-0 pointer-events-none z-0 opacity-10"
    style="background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%;">
  </div>

  <!-- Vignette -->
  <div
    class="fixed inset-0 pointer-events-none z-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.8)_100%)]">
  </div>

  <!-- Header -->
  <header
    class="absolute top-0 left-0 w-full p-4 pt-6 md:p-6 z-30 flex justify-between items-start backdrop-blur-[2px]">
    <div class="flex flex-col">
      <span class="text-[10px] font-bold tracking-[0.2em] uppercase leading-none transition-colors"
        [style.color]="'var(--theme-primary)'" [style.font-family]="'var(--font-header)'">
        {{ geminiService.activeTheme().name }}
      </span>
      <span class="text-[8px] font-mono opacity-60 leading-none mt-1 tracking-wider transition-colors"
        [style.color]="'var(--theme-primary)'">
        {{ geminiService.activeTheme().headerStatus }}
      </span>
    </div>

    <div class="flex items-center gap-2 shrink-0">

      <!-- Secret Key Button (Sparkle) -->
      <button (click)="showSecretInput.set(true)"
        class="w-8 h-8 rounded border border-transparent hover:border-amber-500/30 bg-transparent hover:bg-black/40 flex items-center justify-center text-amber-500/40 hover:text-amber-400 transition-all duration-300 animate-sparkle">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path
            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
        </svg>
      </button>

      <!-- Info Button -->
      <button (click)="toggleAbout()"
        class="w-8 h-8 rounded border border-white/10 bg-black/40 backdrop-blur-sm flex items-center justify-center text-white/30 hover:text-white/80 hover:bg-black/80 hover:border-white/40 transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
      </button>

      <!-- Settings Button -->
      <button (click)="toggleSettings()"
        class="w-8 h-8 rounded border border-white/10 bg-black/40 backdrop-blur-sm flex items-center justify-center text-white/30 hover:text-white/80 hover:bg-black/80 hover:border-white/40 transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
      </button>

      <!-- Reset Button -->
      <button (click)="reset()"
        class="w-8 h-8 rounded border border-white/10 bg-black/40 backdrop-blur-sm flex items-center justify-center text-white/30 hover:text-[var(--theme-primary)] hover:border-[var(--theme-primary)] hover:bg-black/80 transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
          <path d="M21 3v5h-5"></path>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
          <path d="M3 21v-5h5"></path>
        </svg>
      </button>
    </div>
  </header>

  <!-- Info Modal (Unified Terminal Style - Zinc Variant) -->
  @if (showAbout()) {
  <div
    class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in font-mono text-zinc-300"
    (click)="toggleAbout()">
    <div
      class="max-w-md w-full border-2 border-zinc-800 bg-[#050505] p-1 relative shadow-[0_0_40px_rgba(255,255,255,0.05)]"
      (click)="$event.stopPropagation()">

      <!-- Inner CRT Frame -->
      <div class="border border-zinc-800/50 bg-zinc-900/5 p-8 relative overflow-hidden">

        <!-- Scanlines -->
        <div class="absolute inset-0 pointer-events-none opacity-10"
          style="background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%;">
        </div>

        <!-- Header -->
        <div class="flex justify-between items-start mb-8 border-b border-zinc-800/50 pb-2">
          <h2 class="text-zinc-500 text-[10px] tracking-[0.25em] uppercase flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-pulse"></span>
            >>> SYSTEM_INFO.LOG
          </h2>
          <button (click)="toggleAbout()"
            class="text-zinc-600 hover:text-white text-[10px] uppercase tracking-widest transition-colors">[X]</button>
        </div>

        <!-- Content -->
        <div class="space-y-6 text-zinc-400 text-[11px] leading-relaxed relative z-10">
          <p class="font-serif italic text-lg text-zinc-200 border-l-2 border-zinc-700/50 pl-4">
            Ideally, a postcard is a bridge. It says 'I am here, you are there, and I am thinking of you.'
          </p>

          <div class="space-y-4 pt-2">
            <p>
              > Sometimes the distance between people feels vast â€” like planets drifting apart. This project is a quiet
              attempt to close that gap.
            </p>
            <p>
              > It uses AI to translate a visual memory into something tangible. You provide the image; the system helps
              you find the words.
            </p>
            <p>
              > It's a way to slow down and send a signal to someone far away: I saw this, and I thought of you.
            </p>
          </div>
        </div>

        <div
          class="mt-8 w-full border border-zinc-800/30 hover:bg-zinc-900/20 py-3 text-center transition-colors cursor-pointer"
          (click)="toggleAbout()">
          <span class="text-[9px] text-zinc-500 uppercase tracking-[0.2em]">
            [ CLOSE_TERMINAL ]
          </span>
        </div>
      </div>
    </div>
  </div>
  }

  <main class="relative z-10 w-full h-full overflow-y-auto overflow-x-hidden">
    <router-outlet></router-outlet>
  </main>

  <!-- Settings Modal -->
  @if (showSettings()) {
  <div
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in cursor-zoom-out"
    (click)="toggleSettings()">
    <div
      class="w-full max-w-md bg-[#0a0a0a] border border-white/10 p-8 shadow-2xl relative overflow-hidden cursor-default"
      (click)="$event.stopPropagation()">

      <!-- Modal Header -->
      <div class="flex justify-between items-start mb-8 border-b border-white/10 pb-4">
        <div>
          <h2 class="text-xl font-bold font-mono tracking-widest text-white uppercase">System Settings</h2>
          <p class="text-[10px] text-white/40 font-mono mt-1 uppercase tracking-wider">Configuration & Modules</p>
        </div>
        <button (click)="toggleSettings()" class="text-white/40 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Settings List -->
      <div class="space-y-6">

        <!-- Narrative Module Toggle -->
        <div class="flex items-center justify-between group">
          <div class="flex flex-col gap-1">
            <span
              class="text-sm font-bold font-mono text-white tracking-wider group-hover:text-amber-400 transition-colors">
              [ NARRATIVE MODULE ]
            </span>
            <span class="text-[10px] text-white/50 max-w-[200px]">
              Enables poetic reflection and voice synthesis for incoming signals.
            </span>
          </div>

          <button (click)="toggleReflectionMode()"
            class="relative w-12 h-6 rounded-full transition-colors duration-300 focus:outline-none border border-white/20"
            [class.bg-amber-500]="session.reflectionMode() === 'full'"
            [class.bg-white/5]="session.reflectionMode() !== 'full'"
            [class.border-amber-400]="session.reflectionMode() === 'full'">
            <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform duration-300 shadow-sm"
              [class.translate-x-6]="session.reflectionMode() === 'full'"
              [class.translate-x-0]="session.reflectionMode() !== 'full'"></div>
          </button>
        </div>

      </div>

      <!-- Footer -->
      <div class="mt-8 pt-4 border-t border-white/5 text-center">
        <p class="text-[9px] text-white/20 font-mono uppercase tracking-[0.2em]">
          System Version 2.0.4 // Build 2026.01.31
        </p>
      </div>

    </div>
  </div>
  }

  <!-- Secret Code Input -->
  @if (showSecretInput()) {
  <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/95 animate-fade-in cursor-default"
    (click)="closeSecretInput()">
    <div class="flex flex-col items-center gap-6 transition-all duration-300 transform"
      (click)="$event.stopPropagation()" [class.scale-110]="unlockStatus() === 'success'"
      [class.shake]="unlockStatus() === 'error'">

      @if (unlockStatus() === 'success') {
      <div class="flex flex-col items-center gap-4 animate-fade-in">
        <div
          class="w-16 h-16 rounded-full border-2 border-amber-400 flex items-center justify-center text-amber-400 drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <h3 class="text-amber-100 font-mono text-xl tracking-[0.3em] uppercase">Theme Unlocked</h3>
      </div>
      } @else {
      <input #secretInput type="text" [(ngModel)]="secretCode" (keyup.enter)="checkSecretCode()"
        class="bg-transparent border-b border-white/20 text-center font-mono text-xl uppercase tracking-[0.5em] text-white focus:outline-none focus:border-white/50 pb-2 w-80 placeholder:text-white/10 transition-colors"
        placeholder="e.g. 19631122" />
      <p class="text-white/30 font-mono text-[10px] tracking-widest uppercase">
        {{ unlockStatus() === 'error' ? 'Invalid Code' : 'Type Code & Enter' }}
      </p>
      }
    </div>
  </div>
  }
</div>